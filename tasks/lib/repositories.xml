<project name="repositories" default="status">


    <target name="status">
        <echo>Hello world.</echo>
    </target>


    <!--
        Target: init-repository
        -->
    <target name="init-repository">
        <fail unless="repo.dir" />
        <fail unless="repo.source" />

        <!-- If this directory exists and is NOT a git directory, remove it. -->
        <if>
            <and>
                <available file="${repo.dir}" type="dir" />
                <not><available file="${repo.dir}/.git" type="dir" /></not>
            </and>
            <then>
                <fail message="Directory ${repo.dir} exists but is not a git repository. Please remove it before continuing." />
            </then>
        </if>

        <!-- If there is no directory there, clone the repo. -->
        <if>
            <not><available file="${repo.dir}/.git" type="dir" /></not>
            <then>
                <echo>Cloning the repository from ${repo.source}</echo>
                <gitclone repository="${repo.source}" targetPath="${repo.dir}" />
            </then>
        </if>
    </target>


    <!--
        Target: init-branch
        -->
    <target name="init-branch">
        <fail unless="repo.dir" />
        <fail unless="repo.branch" />

        <!-- Make sure we have this branch if it exists upstream. -->
        <trycatch>
            <try>
                <gitfetch repository="${repo.dir}" refspec="${repo.branch}" />
            </try>
            <catch></catch>
        </trycatch>

        <exec command="git branch --list -r origin/${repo.branch}" dir="${repo.dir}" outputproperty="branch_remote" />
        <exec command="git branch --list ${repo.branch}" dir="${repo.dir}" outputproperty="branch_local" />
        <exec command="git rev-parse --abbrev-ref ${repo.branch}@{upstream}" dir="${repo.dir}" outputproperty="branch_tracking" />

        <if>
            <!-- Branch does not exist on local or remote. -->
            <and>
                <equals arg1="${branch_local}" arg2="" />
                <equals arg1="${branch_remote}" arg2="" />
            </and>
            <then>
                <!-- Create an "orphan" branch. -->
                <exec command="git checkout --orphan ${repo.branch}" dir="${repo.dir}" checkreturn="true" logoutput="true" />

                <!-- Remove all the existing files, because this is an orphan branch. -->
                <exec command="git rm -rf" dir="${repo.dir}" />

                <!-- Add a single placeholder file. -->
                <touch file="${repo.dir}/.gitkeep" />

                <gitcommit repository="${repo.dir}" message="Initial commit." allFiles="true">
                    <fileset dir="${repo.dir}">
                        <include name="**/*" />
                    </fileset>
                </gitcommit>
            </then>
            <else>
                <!-- Otherwise just make sure the branch is checked out. -->
                <gitcheckout repository="${repo.dir}" branchname="${repo.branch}" force="true" />
                <gitpull repository="${repo.dir}" refspec="${repo.branch}:${repo.branch}" force="true" />
            </else>
        </if>
    </target>


    <target name="commit">
        <fail unless="build.dir" />
        <fail unless="repo.dir" />
        <fail unless="message" />

        <!-- Get a descriptor of the current ref of the main repository. -->
        <gitdescribe repository="${build.dir}" tags="true" always="true" outputProperty="build_commit_ref" />

        <!-- Check for changes to the artifact repository. -->
        <exec command="git status --porcelain" dir="${repo.dir}" outputProperty="changes_to_deploy" />

        <if>
            <equals arg1="${changes_to_deploy}" arg2="" />
            <then>
                <echo>No changes to ${repo.dir}.</echo>
            </then>
            <else>
                <!-- Check for un-committed changes to the main repository, so
                     that we can include information about these changes in the
                     commit message for this build. -->
                <exec command="git status --porcelain" dir="${build.dir}" outputProperty="modified_files" />

                <if>
                    <not><equals arg1="${modified_files}" arg2="" /></not>
                    <then>
                        <!-- Whitespace within this property value is intentional. -->
                        <property name="build_message">[dirty: ${build_commit_ref}] ${message}

Files with un-committed changes:
${modified_files}
</property>
                    </then>
                    <else>
                        <property name="build_message">[${build_commit_ref}] ${message}</property>
                    </else>
                </if>

                <!-- Commit it all. -->
                <gitcommit repository="${repo.dir}" message="${build_message}" allFiles="true">
                    <fileset dir="${repo.dir}">
                        <include name="**/*" />
                    </fileset>
                </gitcommit>
            </else>
        </if>
    </target>


    <target name="push">
        <fail unless="repo.dir" />
        <fail unless="repo.branch" />

        <!-- If the local repository has forward commits, push them. -->
        <exec command="git diff origin/${repo.branch}" dir="${repo.dir}" outputProperty="has_forward_commits" />

        <if>
            <and>
                <istrue value="${has_forward_commits}" />
                <not><isset property="push" /></not>
            </and>
            <then>
                <input propertyName="push" message="You have local commits. Push your changes?" validArgs="y,n" />
            </then>
        </if>

        <if>
            <and>
                <istrue value="${has_forward_commits}" />
                <equals arg1="${push}" arg2="y" />
            </and>
            <then>
                <gitpush repository="${repo.dir}" refspec="${repo.branch}" tags="true" />
            </then>
        </if>
    </target>

</project>
