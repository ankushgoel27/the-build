<project name="Drupal" default="test">
    <!--
      Include this file in your build.xml with:
        <import file="vendor/palantirnet/the-build/tasks/drupal.xml" />
      -->

    <!-- Uses the project directory name as the projectname -->
    <property name="build.dir" value="${application.startdir}" />
    <basename property="projectname" file="${build.dir}" suffix="local" />

    <!-- If the command wasn't called with an environment, prompt for one. -->
    <propertyprompt propertyName="build.env" defaultValue="vagrant" promptText="Environment" promptCharacter=":" useExistingValue="true" />

    <!-- Load properties for this environment, then for the default environment. -->
    <property file="${build.dir}/conf/build.${build.env}.properties" />
    <property file="${build.dir}/conf/build.default.properties" />

    <!-- These properties will generally be set by a build properties file. -->
    <!-- all drupal.* path properties should be relative to drupal.root (except for drupal.root, which should be relative to the build.dir) -->
    <!-- all build.* path properties should be relative to the build.dir -->
    <property name="drupal.root" value="web" />
    <property name="drupal.uri" value="http://${phing.project.name}.local" />
    <property name="drupal.site_name" value="${phing.project.name}" />
    <property name="drupal.profile" value="standard" />
    <property name="drupal.modules_enable" value="" />

    <property name="drupal.private_files_dir" value="../artifacts/private" />
    <property name="build.drupal.files" value="artifacts/files" />

    <property name="drupal.database.database" value="default" />
    <property name="drupal.database.username" value="drupal" />
    <property name="drupal.database.password" value="drupal" />

    <!-- These properties will generally not change. -->
    <property name="drupal.sites_subdir" value="default" /> <!-- Directory within 'sites' dir in the drupal root -->
    <property name="drupal.files_dir" value="sites/default/files" />
    <property name="drupal.config_sync_directory" value="../conf/drupal/config" /> <!-- pantheon = private/config -->
    <property name="build.drupal.settings" value="conf/drupal/settings.php" />

    <!-- Configure Drush -->
    <taskdef name="drush" classname="Drush\Task" />
    <property name="drush.bin" value="${build.dir}/vendor/bin/drush" />
    <property name="drush.uri" refid="drupal.uri" />
    <property name="drush.root" value="${build.dir}/${drupal.root}" />

    <!-- Use the drushrc for the current environment, but fall back to the default. -->
    <property name="drush.config" value="${build.dir}/conf/drushrc.${build.env}.php" />
    <if>
        <not><available file="${drush.config}" /></not>
        <then>
            <property name="drush.config" value="${build.dir}/conf/drushrc.default.php" override="true" />
        </then>
    </if>

    <!-- Target: test -->
    <target name="test">
        <echo message="Hello World!" />
        <drush command="status" />
        <echoproperties />
    </target>

    <!-- Target: drupal-prepare-filesystem -->
    <target name="drupal-prepare-filesystem" description="Prepare the filesystem for running Drupal.">
        <!-- Make sure the file source directory exists, and create the Drupal
             modules, themes, profiles, and sites directories. -->
        <foreach target="create-placeholder" param="dir">
            <filelist files="${build.drupal.files},${drupal.root}/modules/custom,${drupal.root}/modules/custom,${drupal.root}/themes/custom,${drupal.root}/profiles/custom,${drupal.root}/sites/${drupal.sites_subdir}" />
        </foreach>

        <chmod file="${build.dir}/${drupal.root}/sites/${drupal.sites_subdir}" mode="777" />

        <delete file="${build.dir}/${drupal.root}/sites/${drupal.sites_subdir}/files" />
        <symlink target="${build.dir}/${build.drupal.files}" link="${build.dir}/${drupal.root}/${drupal.files_dir}" />
    </target>


    <!-- Target: drupal-prepare-settings -->
    <target name="drupal-prepare-settings" description="Write the settings.php file for Drupal.">
        <copy file="${build.dir}/${build.drupal.settings}" tofile="${build.dir}/${drupal.root}/sites/${drupal.sites_subdir}/settings.php" overwrite="true" mode="755">
            <filterchain>
                <replacetokens>
                    <token key="database.database" value="${drupal.database.database}" />
                    <token key="database.username" value="${drupal.database.username}" />
                    <token key="database.password" value="${drupal.database.password}" />
                    <token key="drupal.config_sync_directory" value="${drupal.config_sync_directory}" />
                    <token key="hash_salt" value="temporary" />
                </replacetokens>
            </filterchain>
        </copy>
    </target>


    <!-- Target: create-placeholder -->
    <target name="create-placeholder">
        <fail unless="dir" message="The 'dir' property is required." />

        <mkdir dir="${dir}" />
        <touch file="${dir}/.gitkeep" />
    </target>


    <!-- Target: drupal-install -->
    <target name="drupal-install" description="Install Drupal.">
        <drush command="site-install" assume="yes">
            <option name="site-name">${drupal.site_name}</option>
            <option name="sites-subdir">${drupal.sites_subdir}</option>
            <option name="account-name">admin</option>
            <option name="account-pass">admin</option>
        </drush>

        <foreach list="${drupal.modules_enable}" param="module" target="drupal-enable-module" />
    </target>


    <!-- Target: drupal-enable-module -->
    <target name="drupal-enable-module">
        <fail unless="module" />
        <drush command="pm-enable" assume="yes">
            <param>${module}</param>
        </drush>
    </target>

</project>
