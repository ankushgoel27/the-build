<project name="@projectname@" default="build">
    <!-- Run with: vendor/bin/phing -Dbuild.env=vagrant -->
    <!-- For a list of commands, try: vendor/bin/phing -Dbuild.env=vagrant -l -->


    <!-- BOILERPLATE -->
    <!-- Uses the project directory name as the projectname -->
    <property name="build.dir" value="${application.startdir}" />
    <basename property="projectname" file="${build.dir}" suffix="local" />

    <!-- Uses an environment variable for the build.env, if available. -->
    <if>
        <isset property="env.PALANTIR_ENVIRONMENT" />
        <then>
            <property name="build.env" refid="env.PALANTIR_ENVIRONMENT" />
        </then>
    </if>

    <!-- If the command wasn't called with an environment, prompt for one. -->
    <propertyprompt propertyName="build.env" defaultValue="vagrant" promptText="Environment" promptCharacter=":" useExistingValue="true" />

    <!-- Load properties for this environment, then for the default environment. -->
    <property file="${build.dir}/conf/build.${build.env}.properties" />
    <property file="${build.dir}/conf/build.default.properties" />

    <!-- Finally, make these commands available by default. -->
    <import file="vendor/palantirnet/the-build/tasks/drupal.xml" />
    <import file="vendor/palantirnet/the-build/tasks/styleguide.xml" />
    <!-- /BOILERPLATE -->


    <!-- Default target: build -->
    <target name="build" description="Build the application.">
        <phingcall target="drupal-prepare-filesystem" />
        <phingcall target="drupal-prepare-settings" />
        <phingcall target="drupal-prepare-services" />
    </target>

    <target name="configure">
        <phing phingfile="vendor/palantirnet/the-build/tasks/configure.xml" inheritAll="false" dir=".">
            <property name="build.env" value="${build.env}" />
        </phing>

        <phing phingfile="${phing.file.styleguide}" inheritAll="false" target="styleguide-configure">
            <property name="build.dir" value="${build.dir}" />
            <property name="build.env" value="${build.env}" />
            <property name="projectname" value="${projectname}" />
        </phing>
    </target>


    <target name="acquia-deploy">
        <if>
            <or>
                <equals arg1="${build.env}" arg2="vagrant" />
                <equals arg1="${build.env}" arg2="default" />
            </or>
            <then>
                <fail msg="Make sure you're running the deployment with a deploy environment!" />
            </then>
        </if>

        <phingcall target="acquia-build" />
        <phingcall target="build" />
        <phingcall target="acquia-deploy-changes" />
    </target>


</project>
