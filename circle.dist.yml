machine:
  hosts:
    @projectname@.local: 127.0.0.1
  php:
    version: 7.1.9
  node:
    version: 6.11.4
  environment:
    PALANTIR_ENVIRONMENT: circle

general:
  branches:
    ignore:
      - gh-pages
      - /.*(readme|documentation).*/

dependencies:
  pre:
    # Configure PHP
    - echo "sendmail_path=/bin/true" >> "/opt/circleci/php/$(phpenv version-name)/etc/php.ini"
    - echo "date.timezone=America/Chicago" >> "/opt/circleci/php/$(phpenv version-name)/etc/php.ini"
    - echo "memory_limit=256M" > "/opt/circleci/php/$(phpenv version-name)/etc/conf.d/memory.ini"
    # Disable XDebug
    - rm "/opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini"
    # Start the PHP development server
    - nohup php -S localhost:8000 -t web/ > "${CIRCLE_ARTIFACTS}/phpd.log" 2>&1 &

  override:
    - composer install --no-interaction
    - yarn --cwd styleguide/ install

  cache_directories:
    - styleguide/node_modules
    - ~/.composer
    - ~/.npm

test:
  pre:
    - vendor/bin/phing build
    - vendor/bin/phing install
    - vendor/bin/phing migrate

  override:
    - vendor/bin/phing code-review
    - vendor/bin/phing test
